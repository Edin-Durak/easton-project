---
import { Image } from 'astro:assets';
import logo from '../assets/images/logo.svg';
import menuIcon from '../assets/images/icons/menu-icon.svg';
import closeIcon from '../assets/images/icons/close-icon.svg';

---

<header class="header">
    <div class="header__inner container">
        <div class="header__logo">
            <a href="/">
                <Image src={logo} alt="Easton Project Logo" width={100} height={100} loading="eager" />
            </a>
        </div>
        
        <!-- Desktop Navigation -->
        <div class="header__nav">
            <nav class="header__nav-list">
                <a href="/" class="header__nav-link" data-page="home">Home</a>
                <a href="/about" class="header__nav-link" data-page="about">About</a>
                <a href="/contact" class="header__nav-link" data-page="contact">Contact</a>
            </nav>
            <div class="header__nav-buttons">
                <a href="/donate" role="button" class="header__nav-button">Donate</a>
            </div>
        </div>

        <!-- Mobile Menu Button -->
        <button class="header__menu-toggle" aria-label="Toggle navigation menu" aria-expanded="false">
            <Image src={menuIcon} alt="Menu" width={30} height={30} class="header__menu-icon" />
            <Image src={closeIcon} alt="Close" width={30} height={30} class="header__close-icon" />
        </button>
    </div>

    <!-- Mobile Navigation Overlay -->
    <div class="header__mobile-nav">
        <nav class="header__mobile-nav-list">
            <a href="/" class="header__mobile-nav-link" data-page="home">Home</a>
            <a href="/about" class="header__mobile-nav-link" data-page="about">About</a>
            <a href="/contact" class="header__mobile-nav-link" data-page="contact">Contact</a>
            <a href="/donate" class="header__mobile-nav-button">Donate</a>
        </nav>
    </div>
</header>

<script>
    // Initialize header functionality
    function initHeader() {
        const menuToggle = document.querySelector('.header__menu-toggle');
        const mobileNav = document.querySelector('.header__mobile-nav');
        const body = document.body;

        if (menuToggle && mobileNav) {
            // Remove existing event listeners to prevent duplicates
            const newMenuToggle = menuToggle.cloneNode(true);
            menuToggle.parentNode?.replaceChild(newMenuToggle, menuToggle);
            
            // Re-query after replacement
            const freshMenuToggle = document.querySelector('.header__menu-toggle');
            const freshMobileNav = document.querySelector('.header__mobile-nav');

            if (freshMenuToggle && freshMobileNav) {
                // Mobile menu toggle functionality
                freshMenuToggle.addEventListener('click', () => {
                    const isExpanded = freshMenuToggle.getAttribute('aria-expanded') === 'true';
                    
                    freshMenuToggle.setAttribute('aria-expanded', String(!isExpanded));
                    freshMobileNav.classList.toggle('header__mobile-nav--open');
                    body.classList.toggle('no-scroll');
                });

                // Close menu when clicking on links
                const mobileLinks = freshMobileNav.querySelectorAll('.header__mobile-nav-link, .header__mobile-nav-button');
                mobileLinks.forEach(link => {
                    link.addEventListener('click', () => {
                        freshMenuToggle.setAttribute('aria-expanded', 'false');
                        freshMobileNav.classList.remove('header__mobile-nav--open');
                        body.classList.remove('no-scroll');
                    });
                });

                // Close menu when clicking outside
                const outsideClickHandler = (e: Event) => {
                    const target = e.target as Element;
                    if (target && !target.closest('.header')) {
                        freshMenuToggle.setAttribute('aria-expanded', 'false');
                        freshMobileNav.classList.remove('header__mobile-nav--open');
                        body.classList.remove('no-scroll');
                    }
                };

                // Remove existing listener and add new one
                document.removeEventListener('click', outsideClickHandler);
                document.addEventListener('click', outsideClickHandler);
            }
        }
    }

    // Active navigation link functionality
    function setActiveNavLink() {
        const currentPath = window.location.pathname;
        const navLinks = document.querySelectorAll('[data-page]');
        
        navLinks.forEach(link => {
            const linkPath = link.getAttribute('href');
            const linkPage = link.getAttribute('data-page');
            
            // Remove active class from all links
            link.classList.remove('active');
            
            // Add active class to current page link
            if (linkPath === currentPath || (currentPath === '/' && linkPage === 'home')) {
                link.classList.add('active');
            }
        });
    }

    // Close mobile menu on screen size change
    function handleResize() {
        const menuToggle = document.querySelector('.header__menu-toggle');
        const mobileNav = document.querySelector('.header__mobile-nav');
        const body = document.body;

        if (menuToggle && mobileNav && window.innerWidth > 768) {
            // Close mobile menu when screen becomes desktop size
            menuToggle.setAttribute('aria-expanded', 'false');
            mobileNav.classList.remove('header__mobile-nav--open');
            body.classList.remove('no-scroll');
        }
    }

    // Initialize on page load
    initHeader();
    setActiveNavLink();

    // Handle View Transitions navigation
    document.addEventListener('astro:page-load', () => {
        initHeader();
        setActiveNavLink();
    });

    // Handle window resize
    window.addEventListener('resize', handleResize);
</script>