---
import { Image } from 'astro:assets';
import logo from '../assets/images/logo.svg';
import menuIcon from '../assets/images/icons/menu-icon.svg';
import closeIcon from '../assets/images/icons/close-icon.svg';

---

<header class="header">
    <div class="header__inner container">
        <div class="header__logo">
            <a href="/">
                <Image src={logo} alt="Easton Project Logo" width={100} height={100} loading="eager" />
            </a>
        </div>
        
        <!-- Desktop Navigation -->
        <div class="header__nav">
            <nav class="header__nav-list">
                <a href="/" class="header__nav-link" data-page="home">Home</a>
                <a href="/about" class="header__nav-link" data-page="about">About</a>
                <a href="/contact" class="header__nav-link" data-page="contact">Contact</a>
            </nav>
            <div class="header__nav-buttons">
                <button type="button" class="header__nav-button" id="desktop-donate-btn">Donate</button>
            </div>
        </div>

        <!-- Mobile Menu Button -->
        <button class="header__menu-toggle" aria-label="Toggle navigation menu" aria-expanded="false">
            <Image src={menuIcon} alt="Menu" width={30} height={30} class="header__menu-icon" />
            <Image src={closeIcon} alt="Close" width={30} height={30} class="header__close-icon" />
        </button>
    </div>

    <!-- Mobile Navigation Overlay -->
    <div class="header__mobile-nav">
        <nav class="header__mobile-nav-list">
            <a href="/" class="header__mobile-nav-link" data-page="home">Home</a>
            <a href="/about" class="header__mobile-nav-link" data-page="about">About</a>
            <a href="/contact" class="header__mobile-nav-link" data-page="contact">Contact</a>
            <button type="button" class="header__mobile-nav-button" id="mobile-donate-btn">Donate</button>
        </nav>
    </div>
</header>

<script>
    // Initialize header functionality
    function initHeader() {
        const menuToggle = document.querySelector('.header__menu-toggle');
        const mobileNav = document.querySelector('.header__mobile-nav');
        const body = document.body;

        if (menuToggle && mobileNav) {
            // Remove existing event listeners to prevent duplicates
            const newMenuToggle = menuToggle.cloneNode(true);
            menuToggle.parentNode?.replaceChild(newMenuToggle, menuToggle);
            
            // Re-query after replacement
            const freshMenuToggle = document.querySelector('.header__menu-toggle');
            const freshMobileNav = document.querySelector('.header__mobile-nav');

            if (freshMenuToggle && freshMobileNav) {
                // Mobile menu toggle functionality
                freshMenuToggle.addEventListener('click', () => {
                    const isExpanded = freshMenuToggle.getAttribute('aria-expanded') === 'true';
                    
                    freshMenuToggle.setAttribute('aria-expanded', String(!isExpanded));
                    freshMobileNav.classList.toggle('header__mobile-nav--open');
                    body.classList.toggle('no-scroll');
                });

                // Close menu when clicking on links
                const mobileLinks = freshMobileNav.querySelectorAll('.header__mobile-nav-link');
                mobileLinks.forEach(link => {
                    link.addEventListener('click', () => {
                        freshMenuToggle.setAttribute('aria-expanded', 'false');
                        freshMobileNav.classList.remove('header__mobile-nav--open');
                        body.classList.remove('no-scroll');
                    });
                });

                // Close menu when clicking on donate button (but don't prevent modal from opening)
                const mobileDonateButton = freshMobileNav.querySelector('#mobile-donate-btn');
                if (mobileDonateButton) {
                    mobileDonateButton.addEventListener('click', () => {
                        freshMenuToggle.setAttribute('aria-expanded', 'false');
                        freshMobileNav.classList.remove('header__mobile-nav--open');
                        body.classList.remove('no-scroll');
                    });
                }

                // Close menu when clicking outside
                const outsideClickHandler = (e: Event) => {
                    const target = e.target as Element;
                    if (target && !target.closest('.header')) {
                        freshMenuToggle.setAttribute('aria-expanded', 'false');
                        freshMobileNav.classList.remove('header__mobile-nav--open');
                        body.classList.remove('no-scroll');
                    }
                };

                // Remove existing listener and add new one
                document.removeEventListener('click', outsideClickHandler);
                document.addEventListener('click', outsideClickHandler);
            }
        }
    }

    // Active navigation link functionality
    function setActiveNavLink() {
        const currentPath = window.location.pathname;
        const navLinks = document.querySelectorAll('[data-page]');
        
        navLinks.forEach(link => {
            const linkPath = link.getAttribute('href');
            const linkPage = link.getAttribute('data-page');
            
            // Remove active class from all links
            link.classList.remove('active');
            
            // Add active class to current page link
            // Handle both local development and GitHub Pages deployment
            if (linkPath === currentPath || 
                (currentPath === '/' && linkPage === 'home') ||
                (currentPath === '/' && linkPage === 'home') ||
                (currentPath === '/about' && linkPage === 'about') ||
                (currentPath === '/about' && linkPage === 'about') ||
                (currentPath === '/contact' && linkPage === 'contact') ||
                (currentPath === '/contact' && linkPage === 'contact')) {
                link.classList.add('active');
            }
        });
    }

    // Close mobile menu on screen size change
    function handleResize() {
        const menuToggle = document.querySelector('.header__menu-toggle');
        const mobileNav = document.querySelector('.header__mobile-nav');
        const body = document.body;

        if (menuToggle && mobileNav && window.innerWidth > 768) {
            // Close mobile menu when screen becomes desktop size
            menuToggle.setAttribute('aria-expanded', 'false');
            mobileNav.classList.remove('header__mobile-nav--open');
            body.classList.remove('no-scroll');
        }
    }

    // Initialize on page load
    initHeader();
    setActiveNavLink();

    // Handle View Transitions navigation
    document.addEventListener('astro:page-load', () => {
        initHeader();
        setActiveNavLink();
    });

    // Handle window resize
    window.addEventListener('resize', handleResize);

    // Simple Donate Modal
    function showDonateModal() {
        // Create modal overlay
        const modalOverlay = document.createElement('div');
        modalOverlay.style.cssText = `
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            z-index: 10000;
            display: flex;
            align-items: center;
            justify-content: center;
        `;

        // Create modal content
        const modalContent = document.createElement('div');
        modalContent.style.cssText = `
            background: var(--color-dark-navy);
            padding: var(--spacing-8);
            border-radius: var(--rounded-lg);
            text-align: center;
            max-width: 500px;
            width: 90%;
            position: relative;
            border: 2px solid var(--color-warm-beige);
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
        `;

        // Add close button
        const closeBtn = document.createElement('button');
        closeBtn.innerHTML = 'Ã—';
        closeBtn.style.cssText = `
            position: absolute;
            top: var(--spacing-4);
            right: var(--spacing-5);
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: var(--color-warm-beige);
            transition: color 0.3s ease;
            padding: var(--spacing-2);
            border-radius: var(--rounded-2xs);
        `;

        // Add hover effect for close button
        closeBtn.addEventListener('mouseenter', () => {
            closeBtn.style.opacity = '0.9';
            
        });
        closeBtn.addEventListener('mouseleave', () => {
            closeBtn.style.opacity = '1';
        });

        // Add title
        const title = document.createElement('h2');
        title.textContent = 'Support The Easton Project';
        title.style.cssText = `
            margin: 0 0 var(--spacing-6) 0;
            color: var(--color-warm-beige);
            font-size: 1.75rem;
            font-weight: 700;
            font-family: var(--font-family-base);
            line-height: 1.2;
        `;

        // Add description
        const description = document.createElement('p');
        description.textContent = 'Your donation helps us provide critical support for individuals facing addiction and mental health challenges in Quebec.';
        description.style.cssText = `
            margin: 0 0 var(--spacing-8) 0;
            color: var(--color-warm-beige);
            line-height: 1.6;
            font-size: 1.125rem;
            font-family: var(--font-family-secondary);
        `;

        // Create PayPal button container
        const paypalContainer = document.createElement('div');
        paypalContainer.id = 'paypal-donate-modal-container';
        paypalContainer.style.cssText = `
            display: flex;
            justify-content: center;
            align-items: center;
            padding: var(--spacing-6);
            background-color: var(--color-light-blue);
            border-radius: var(--rounded);
            border: 2px solid transparent;
            transition: border-color 0.3s ease;
        `;

        // Add hover effect for PayPal container
        paypalContainer.addEventListener('mouseenter', () => {
            paypalContainer.style.borderColor = 'var(--color-warm-beige)';
        });
        paypalContainer.addEventListener('mouseleave', () => {
            paypalContainer.style.borderColor = 'transparent';
        });

        // Assemble modal
        modalContent.appendChild(closeBtn);
        modalContent.appendChild(title);
        modalContent.appendChild(description);
        modalContent.appendChild(paypalContainer);
        modalOverlay.appendChild(modalContent);
        document.body.appendChild(modalOverlay);

        // Prevent body scroll
        document.body.style.overflow = 'hidden';

        // Close modal function
        const closeModal = () => {
            document.body.removeChild(modalOverlay);
            document.body.style.overflow = '';
        };

        // Close modal handlers
        closeBtn.addEventListener('click', closeModal);
        modalOverlay.addEventListener('click', (e) => {
            if (e.target === modalOverlay) {
                closeModal();
            }
        });

        // Close on Escape key
        const handleEscape = (e: KeyboardEvent) => {
            if (e.key === 'Escape') {
                closeModal();
                document.removeEventListener('keydown', handleEscape);
            }
        };
        document.addEventListener('keydown', handleEscape);

        // Render PayPal button with optimized loading
        function renderPayPalButton() {
            if (typeof (window as any).PayPal !== 'undefined') {
                (window as any).PayPal.Donation.Button({
                    env: 'production',
                    hosted_button_id: 'ETVKFLEWWXSQC',
                    image: {
                        src: 'https://www.paypalobjects.com/en_US/i/btn/btn_donateCC_LG.gif',
                        title: 'PayPal - The safer, easier way to pay online!',
                        alt: 'Donate with PayPal button'
                    },
                    onComplete: function (params: any) {
                        console.log('Donation completed:', params);
                        closeModal();
                    },
                    onError: function (error: any) {
                        console.error('PayPal donation error:', error);
                        closeModal();
                    }
                }).render('#paypal-donate-modal-container');
            } else {
                // Retry if PayPal SDK not loaded yet
                setTimeout(renderPayPalButton, 100);
            }
        }
        
        renderPayPalButton();
    }

    // Setup donate button event listeners
    function setupDonateButtons() {
        const desktopBtn = document.getElementById('desktop-donate-btn');
        const mobileBtn = document.getElementById('mobile-donate-btn');

        if (desktopBtn) {
            desktopBtn.addEventListener('click', showDonateModal);
        }

        if (mobileBtn) {
            mobileBtn.addEventListener('click', showDonateModal);
        }
    }

    // Initialize on page load
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', setupDonateButtons);
    } else {
        setupDonateButtons();
    }

    // Re-initialize after view transitions
    document.addEventListener('astro:page-load', setupDonateButtons);
</script>